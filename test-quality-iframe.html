<html>
  <head>
    <title>stream local video file</title>
    <script src="./daily.js"></script>
    <script src="./canvas-helpers.js"></script>
    <!-- <script src="https://unpkg.com/@daily-co/daily-js@0.27.0"></script> -->
    <!-- <script src="https://unpkg.com/@daily-co/daily-js"></script> -->
  </head>
  <body onload="main()">
    <div id="videos" style="width: 100%"></div>
    <script>
      let testCanceled = false;
      let testStarted = false;
      let testFailed = false;
      let msgPort = null;
      let srcVid = null;
      let srcCanvas = null;
      let canvasHelper = null;
      let testCall = DailyIframe.createCallObject();
      let testParams = {};

      async function main() {
        window.addEventListener('message', handleMessage);

        window.testCall = testCall;
      }

      function handleMessage(msg) {
        console.log('handleMessage', msg);
        switch (msg.data?.action) {
          case 'connect':
            msgPort = msg.ports[0];
            testParams = msg.data.testParams || {};
            _setupSrc(testParams.style);

            break;
          case 'stop':
            cancelTest();
            break;
        }
      }

      function _setupSrc(style = 'video') {
        if (style === 'video') {
          _setupSrcVid();
          if (!srcVid) {
            // fall back
            console.error('video element capture not supported. Using canvas.');
            _setupSrcCanvas();
          }
        } else {
          _setupSrcCanvas(style);
        }
        if (!srcVid && !srcCanvas) {
          testFailed = 'captureStream not supported in browser';
          msgPort?.postMessage({
            results: {
              result: 'failed',
              errorMsg: testFailed,
            },
          });
        }
      }

      function _setupSrcCanvas(style = 'sequence') {
        let canvas = document.createElement('canvas');
        if (!canvas.captureStream) return;

        let videosDiv = document.getElementById('videos');
        canvas.id = 'srcCanvas';
        canvas.width = 1920;
        canvas.height = 1080;
        videosDiv.appendChild(canvas);
        srcCanvas = canvas;

        canvasHelper = new CanvasRenderer(canvas, runTest);
        canvasHelper.render(style);
      }

      function _setupSrcVid() {
        let vid = document.createElement('video');
        if (!vid.captureStream && !vid.mozCaptureStream) return;

        srcVid = vid;
        let videosDiv = document.getElementById('videos');
        srcVid = document.createElement('video');
        srcVid.muted = true;
        srcVid.src = 'big_buck_bunny.mp4';
        srcVid.id = 'srcVid';

        srcVid.autoplay = true;
        srcVid.loop = true;

        srcVid.onplay = () => {
          void runTest();
        };
        srcVid.style.width = '100%';

        videosDiv.appendChild(srcVid);
      }

      async function runTest() {
        console.log('run test yo');
        if (testCanceled) {
          console.log('test canceled?');
          return;
        }

        let vidStream;
        if (srcVid?.captureStream) {
          console.log('from video??');
          vidStream = srcVid.captureStream();
        } else if (srcVid?.mozCaptureStream) {
          console.log('from moz???');
          vidStream = srcVid.mozCaptureStream();
        } else if (srcCanvas?.captureStream) {
          console.log('capture stream');
          vidStream = srcCanvas.captureStream();
          console.log('end');
        } else {
          console.log('captureStream not supported in browser');
          msgPort?.postMessage({
            results: {
              result: 'failed',
              errorMsg: 'captureStream not supported in browser',
            },
          });
          return;
        }

        let vidTrack = vidStream.getVideoTracks()[0];

        let url = testParams.url;
        let duration = testParams.duration;
        let sendSettings = testParams.sendSettings;
        window.dailyDebug = {
          callQualityTest: { url, duration, sendSettings },
        };
        if (testParams.verbose) {
          window.dailyDebug.metrics = { Telemetry: true };
        }

        console.log('running test call', url);
        let results = await testCall.testCallQuality({
          videoTrack: vidStream.getVideoTracks()[0],
        });

        msgPort?.postMessage({ results });
        testCall.destroy();
        if (srcVid) {
          srcVid.pause();
          srcVid.srcObj = null;
        }
        let videosDiv = document.getElementById('videos');
        srcVid && videosDiv.removeChild(srcVid);
        srcCanvas && videosDiv.removeChild(srcCanvas);
        canvasHelper?.abort();
        testCanceled = true;
      }

      function cancelTest() {
        console.log('test canceled');
        testCanceled = true;
        testCall.stopTestCallQuality();
        canvasHelper?.abort();
      }
    </script>
  </body>
</html>
